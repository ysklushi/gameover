<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勞基法試煉</title>
    <!-- 引入 html2canvas 函式庫，用於畫面截圖 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px 0;
        }

        .main-container {
            max-width: 900px;
            width: 90%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* 主頁樣式 */
        .main-page {
            text-align: center;
        }

        .game-title {
            font-size: 3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            background: linear-gradient(45deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .poster-image {
            width: 300px;
            height: auto;
            display: block;
            border-radius: 15px;
            margin: 20px auto;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .game-subtitle {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        .game-button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .enter-game {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .enter-game:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }

        .practice-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .practice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        /* === 角色選擇樣式 === */
        .character-selection {
            text-align: center;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .character-card {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .character-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
        }

        .character-card.selected {
            transform: translateY(-5px) scale(1.05);
            border: 4px solid #f1c40f;
            box-shadow: 0 10px 30px rgba(241, 196, 15, 0.3);
        }

        .character-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .character-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 10px;
        }

        .name-input-section {
            display: none;
            text-align: center;
            margin-bottom: 30px;
        }

        .name-input {
            padding: 12px 20px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 25px;
            width: 300px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .name-input:focus {
            border-color: #3498db;
        }

        .start-button-section {
            display: none;
            text-align: center;
        }

        .hell-button {
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            background: linear-gradient(45deg, #27ae60, #229954);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .hell-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        /* 遊戲進行樣式 */
        .game-play {}

        .question-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 50px;
        }

        .question-number {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.6;
            font-weight: 500;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-button {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            text-align: left;
        }

        .option-button:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .option-button.selected {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .option-button.correct {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .option-button.incorrect {
            border-color: #e74c3c;
            background: #fdeaea;
        }

        .submit-answer, .next-question {
            padding: 12px 25px;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-answer {
            background: linear-gradient(45deg, #3498db, #2980b9);
            margin-right: 10px;
        }

        .submit-answer:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .submit-answer:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .next-question {
            background: linear-gradient(45deg, #27ae60, #229954);
            display: none;
        }

        .next-question:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .error-report-link {
            position: absolute;
            bottom: 15px;
            right: 25px;
            font-size: 0.9em;
            color: #777;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .error-report-link:hover {
            color: #e74c3c;
            text-decoration: underline;
        }

        /* === 狀態面板樣式 === */
        .status-panel {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 15px;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .character-avatar {
            font-size: 4em;
            text-align: center;
        }
        
        .status-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            grid-template-areas:
                "role name"
                "total correct"
                "wrong hearts"
                "timer timer";
        }

        @media (min-width: 850px) {
            .status-info {
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: auto auto;
                gap: 10px;
                grid-template-areas:
                    "role name total correct wrong"
                    "hearts hearts hearts timer timer";
            }
        }

        .status-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        #status-role { grid-area: role; }
        #status-name { grid-area: name; }
        #status-total { grid-area: total; }
        #status-correct { grid-area: correct; }
        #status-wrong { grid-area: wrong; }
        #status-hearts { grid-area: hearts; }
        #status-timer { grid-area: timer; }

        .status-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .hearts {
            color: #e74c3c;
            font-size: 1.5em;
        }

        /* 命運機會卡片樣式 */
        .fate-chance-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }

        .fate-chance-modal {
            background: white; padding: 40px; border-radius: 20px;
            text-align: center; max-width: 500px; width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .fate-chance-buttons {
            display: flex; gap: 20px; justify-content: center; margin-top: 30px;
        }

        .fate-button, .chance-button {
            padding: 15px 25px; font-size: 1.1em; font-weight: bold;
            border: none; border-radius: 15px; cursor: pointer;
            transition: all 0.3s ease; color: white;
        }

        .fate-button { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .chance-button { background: linear-gradient(45deg, #f39c12, #e67e22); }
        .fate-button:hover, .chance-button:hover {
            transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        /* 結果頁面樣式 */
        .result-page { text-align: center; }
        .result-title { font-size: 2.5em; margin-bottom: 20px; font-weight: bold; }
        .victory { color: #27ae60; }
        .defeat { color: #e74c3c; }

        .result-stats {
            background: #f8f9fa; border-radius: 15px; padding: 20px;
            margin: 25px 0; display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; border: 1px solid #e9ecef;
        }

        .result-stat-item { text-align: center; }
        .result-stat-label { font-size: 1em; color: #6c757d; margin-bottom: 8px; }
        .result-stat-value { font-size: 1.4em; font-weight: bold; color: #2c3e50; }
        .result-stat-value.highlight-green { color: #27ae60; }
        .result-stat-value.highlight-red { color: #e74c3c; }
        
        .result-image-placeholder {
            width: 300px;
            border-radius: 15px;
            margin: 20px auto;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-image-placeholder img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .result-buttons-container {
            display: flex; justify-content: center; gap: 20px;
            margin-top: 30px; flex-wrap: wrap;
        }

        .restart-button, .download-button {
            padding: 15px 30px; font-size: 1.1em; font-weight: bold;
            border: none; border-radius: 50px; cursor: pointer;
            transition: all 0.3s ease;
        }

        .restart-button {
            background: linear-gradient(45deg, #3498db, #2980b9); color: white;
        }
        .restart-button:hover {
            transform: translateY(-3px); box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .download-button {
            background: linear-gradient(45deg, #f39c12, #e67e22); color: white;
        }
        .download-button:hover {
            transform: translateY(-3px); box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }

        .creator-info {
            position: fixed; bottom: 20px; right: 20px;
            font-size: 0.9em; color: rgba(255, 255, 255, 0.8); cursor: pointer;
            transition: color 0.3s ease; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        .creator-info:hover { color: white; text-decoration: underline; }

        .explanation {
            background: #e8f5e8; border: 2px solid #27ae60; border-radius: 10px;
            padding: 15px; margin-top: 15px; text-align: left; display: none;
        }
        .explanation.show { display: block; }
        .explanation-title { font-weight: bold; color: #27ae60; margin-bottom: 8px; }

        @media (max-width: 768px) {
            .game-title { font-size: 2.2em; }
            .poster-image { width: 250px; }
            .main-container { padding: 20px; }
            .options-container { grid-template-columns: 1fr; }
            .character-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
            .result-stats { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }

        .hidden { display: none !important; }

        .card-result {
            background: #f0f8ff; border: 2px solid #3498db; border-radius: 15px;
            padding: 20px; margin: 20px 0; text-align: center;
        }
        .card-title { font-size: 1.5em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .card-description { color: #555; margin-bottom: 15px; line-height: 1.5; }
        .card-effect { font-size: 1.3em; font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>
    <!-- 主頁面 -->
    <div id="main-page" class="main-container main-page">
        <h1 class="game-title">勞基法試煉</h1>
        <img src="picture1.png" alt="勞基法試煉遊戲主圖" class="poster-image">
        <p class="game-subtitle">
            準備好接受勞基法的終極考驗了嗎？<br>
            選擇你的角色，踏上成為勞基法大師的道路！
        </p>
        <div class="button-container">
            <button class="game-button enter-game" onclick="showCharacterSelection()">🎮 進入遊戲</button>
            <a href="https://karoboard.netlify.app/" target="_blank" class="game-button practice-button">📚 先去閉關修練</a>
        </div>
    </div>

    <!-- 角色選擇頁面 -->
    <div id="character-page" class="main-container character-selection hidden">
        <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 2.5em;">選擇你的角色</h1>
        <div class="character-grid">
            <div class="character-card" data-role="勞工" data-emoji="👷"><div class="character-name">勞工</div><img src="role1.jpeg" alt="勞工角色" class="character-image"></div>
            <div class="character-card" data-role="雇主" data-emoji="💼"><div class="character-name">雇主</div><img src="role2.jpeg" alt="雇主角色" class="character-image"></div>
            <div class="character-card" data-role="律師" data-emoji="⚖️"><div class="character-name">律師</div><img src="role3.jpeg" alt="律師角色" class="character-image"></div>
            <div class="character-card" data-role="法官" data-emoji="👨‍⚖️"><div class="character-name">法官</div><img src="role4.jpeg" alt="法官角色" class="character-image"></div>
        </div>
        <div class="name-input-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">為你的角色命名</h3>
            <input type="text" class="name-input" placeholder="輸入角色名稱" maxlength="10">
        </div>
        <div class="start-button-section">
            <button class="hell-button" onclick="startGame()">🔥 我不入地獄誰入地獄</button>
        </div>
    </div>

    <!-- 遊戲進行頁面 -->
    <div id="game-page" class="main-container game-play hidden">
        <!-- 狀態面板 -->
        <div class="status-panel">
            <div class="character-avatar" id="player-avatar">👷</div>
            <div class="status-info">
                <!-- 第一排 -->
                <div class="status-item" id="status-role"><div class="status-label">角色</div><div class="status-value" id="player-role">勞工</div></div>
                <div class="status-item" id="status-name"><div class="status-label">姓名</div><div class="status-value" id="player-name">玩家</div></div>
                <div class="status-item" id="status-total"><div class="status-label">總題數</div><div class="status-value" id="total-questions">0</div></div>
                <div class="status-item" id="status-correct"><div class="status-label">答對</div><div class="status-value" id="correct-answers" style="color: #27ae60;">0</div></div>
                <div class="status-item" id="status-wrong"><div class="status-label">答錯</div><div class="status-value" id="wrong-answers" style="color: #e74c3c;">0</div></div>
                <!-- 第二排 -->
                <div class="status-item" id="status-hearts"><div class="status-label">生命值</div><div class="status-value hearts" id="hearts">❤️❤️❤️</div></div>
                <div class="status-item" id="status-timer"><div class="status-label">遊戲時間</div><div class="status-value" id="game-timer">00:00</div></div>
            </div>
        </div>

        <!-- 題目區域 -->
        <div class="question-section">
            <div class="question-number" id="question-counter">第 1 題</div>
            <div class="question-text" id="current-question">請選擇角色開始遊戲</div>
            <div class="options-container" id="options-container"></div>
            <div style="text-align: center;">
                <button class="submit-answer" id="submit-btn" onclick="submitAnswer()" disabled>確認答案</button>
                <button class="next-question" id="next-btn" onclick="nextQuestion()">下一題</button>
            </div>
            <div class="explanation" id="explanation">
                <div class="explanation-title">解答說明：</div>
                <div id="explanation-text"></div>
            </div>
            <a href="https://karolushi.netlify.app/#contact" target="_blank" class="error-report-link">錯謬回報</a>
        </div>
    </div>

    <!-- 命運機會卡片覆蓋層 -->
    <div class="fate-chance-overlay" id="fate-chance-overlay">
        <div class="fate-chance-modal">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">選擇你的命運！</h2>
            <p style="color: #555; margin-bottom: 30px; line-height: 1.6;">
                答題滿5題了！你可以選擇「命運」或「機會」來改變你的處境！<br>
                但要小心，有好有壞哦～
            </p>
            <div class="fate-chance-buttons">
                <button class="fate-button" onclick="drawCard('fate')">🎯 命運</button>
                <button class="chance-button" onclick="drawCard('chance')">🎲 機會</button>
            </div>
        </div>
    </div>

    <!-- 結果頁面 -->
    <div id="victory-page" class="main-container result-page hidden">
        <h1 class="result-title victory">🎉 恭喜你！🎉</h1>
        <p style="font-size: 1.3em; color: #27ae60; margin-bottom: 0;">能夠把題庫作答完畢，你真是勞基法大師啊！</p>
        <div class="result-stats" id="victory-stats-container"></div>
        <div class="result-image-placeholder">
            <img src="passall.png" alt="遊戲勝利示意圖">
        </div>
        <div class="result-buttons-container">
            <button class="restart-button" onclick="restartGame()">🎮 重新開始</button>
            <button class="download-button" onclick="downloadResultImage('victory-page', event)">🖼️ 挑戰紀錄下載</button>
        </div>
    </div>

    <div id="defeat-page" class="main-container result-page hidden">
        <h1 class="result-title defeat">💔 學海無涯</h1>
        <p style="font-size: 1.3em; color: #e74c3c; margin-bottom: 0;">請再接再厲！回去修練後再來挑戰！</p>
        <div class="result-stats" id="defeat-stats-container"></div>
        <div class="result-image-placeholder">
            <img src="lose.png" alt="遊戲失敗示意圖">
        </div>
        <div class="result-buttons-container">
            <button class="restart-button" onclick="restartGame()">🔄 投胎重生</button>
            <button class="download-button" onclick="downloadResultImage('defeat-page', event)">🖼️ 挑戰紀錄下載</button>
        </div>
    </div>

    <div class="creator-info" onclick="window.open('https://karolushi.netlify.app/', '_blank')">過勞律師製作</div>

    <!-- 載入遊戲資料 -->
    <script src="questions-part1.js"></script>
    <script src="questions-part2.js"></script>
    <script src="questions-part3.js"></script>
    <script src="questions-part4.js"></script>
    <script src="questions-part5.js"></script>
    <script src="game-data.js"></script>
    
    <!-- 遊戲主要邏輯 -->
    <script>
        let gameState = {
            currentPage: 'main', selectedRole: '', selectedEmoji: '', playerName: '', hearts: 3, 
            totalQuestions: 0, correctAnswers: 0, wrongAnswers: 0, currentQuestionIndex: 0,
            usedQuestions: [], selectedAnswer: null, questionsBeforeFateChance: 0,
            gameTimer: null, elapsedTime: 0 
        };

        function showCharacterSelection() {
            document.getElementById('main-page').classList.add('hidden');
            document.getElementById('character-page').classList.remove('hidden');
            const characterCards = document.querySelectorAll('.character-card');
            const nameInputSection = document.querySelector('.name-input-section');
            const startButtonSection = document.querySelector('.start-button-section');
            const nameInput = document.querySelector('.name-input');
            characterCards.forEach(card => {
                card.addEventListener('click', function() {
                    characterCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.selectedRole = this.dataset.role;
                    gameState.selectedEmoji = this.dataset.emoji;
                    nameInputSection.style.display = 'block';
                    if (gameState.playerName) startButtonSection.style.display = 'block';
                });
            });
            nameInput.addEventListener('input', function() {
                gameState.playerName = this.value.trim();
                if (gameState.playerName && gameState.selectedRole) {
                    startButtonSection.style.display = 'block';
                } else {
                    startButtonSection.style.display = 'none';
                }
            });
        }

        function startGame() {
            if (!gameState.playerName || !gameState.selectedRole) return;
            document.getElementById('character-page').classList.add('hidden');
            document.getElementById('game-page').classList.remove('hidden');
            gameState.hearts = 3; gameState.totalQuestions = 0; gameState.correctAnswers = 0;
            gameState.wrongAnswers = 0; gameState.currentQuestionIndex = 0; gameState.usedQuestions = [];
            gameState.selectedAnswer = null; gameState.questionsBeforeFateChance = 0; gameState.elapsedTime = 0;
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            gameState.gameTimer = setInterval(() => {
                gameState.elapsedTime++;
                const minutes = Math.floor(gameState.elapsedTime / 60).toString().padStart(2, '0');
                const seconds = (gameState.elapsedTime % 60).toString().padStart(2, '0');
                document.getElementById('game-timer').textContent = `${minutes}:${seconds}`;
            }, 1000);
            updateStatusPanel();
            loadNextQuestion();
        }

        function updateStatusPanel() {
            document.getElementById('player-avatar').textContent = gameState.selectedEmoji;
            document.getElementById('player-role').textContent = gameState.selectedRole;
            document.getElementById('player-name').textContent = gameState.playerName;
            document.getElementById('total-questions').textContent = gameState.totalQuestions;
            document.getElementById('correct-answers').textContent = gameState.correctAnswers;
            document.getElementById('wrong-answers').textContent = gameState.wrongAnswers;
            document.getElementById('hearts').textContent = '❤️'.repeat(Math.max(0, Math.floor(gameState.hearts)));
        }

        function loadNextQuestion() {
            if (gameState.questionsBeforeFateChance >= 5) { showFateChanceModal(); return; }
            if (gameState.usedQuestions.length >= questionBank.length) { showVictoryPage(); return; }
            let availableQuestions = questionBank.filter(q => !gameState.usedQuestions.includes(q.id));
            let randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            gameState.currentQuestionIndex = randomQuestion.id;
            gameState.usedQuestions.push(randomQuestion.id);
            gameState.totalQuestions++;
            gameState.selectedAnswer = null;
            document.getElementById('question-counter').textContent = `第 ${gameState.totalQuestions} 題`;
            document.getElementById('current-question').textContent = randomQuestion.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            randomQuestion.options.forEach((option, index) => {
                const optionButton = document.createElement('div');
                optionButton.className = 'option-button';
                optionButton.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionButton.dataset.index = index;
                optionButton.addEventListener('click', function() {
                    document.querySelectorAll('.option-button').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.selectedAnswer = parseInt(this.dataset.index);
                    document.getElementById('submit-btn').disabled = false;
                });
                optionsContainer.appendChild(optionButton);
            });
            document.getElementById('submit-btn').style.display = 'inline-block';
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('explanation').classList.remove('show');
            updateStatusPanel();
        }

        function submitAnswer() {
            if (gameState.selectedAnswer === null) return;
            const currentQuestion = questionBank.find(q => q.id === gameState.currentQuestionIndex);
            const isCorrect = gameState.selectedAnswer === currentQuestion.correct;
            const optionButtons = document.querySelectorAll('.option-button');
            optionButtons.forEach((btn, index) => {
                if (index === currentQuestion.correct) btn.classList.add('correct');
                else if (index === gameState.selectedAnswer && !isCorrect) btn.classList.add('incorrect');
                btn.style.pointerEvents = 'none';
            });
            if (isCorrect) gameState.correctAnswers++;
            else { gameState.wrongAnswers++; gameState.hearts -= 1; }
            updateStatusPanel();
            if (gameState.hearts <= 0) { setTimeout(() => showDefeatPage(), 1500); return; }
            gameState.questionsBeforeFateChance++;
            document.getElementById('explanation-text').textContent = currentQuestion.explanation;
            document.getElementById('explanation').classList.add('show');
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
        }

        function nextQuestion() { loadNextQuestion(); }
        function showFateChanceModal() { document.getElementById('fate-chance-overlay').style.display = 'flex'; }
        
        function drawCard(type) {
            const cards = type === 'fate' ? fateCards : chanceCards;
            const randomCard = cards[Math.floor(Math.random() * cards.length)];
            document.getElementById('fate-chance-overlay').style.display = 'none';
            showCardResult(randomCard);
        }

        function showCardResult(card) {
            const modal = document.createElement('div');
            modal.className = 'fate-chance-overlay';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="fate-chance-modal">
                    <div class="card-result">
                        <div class="card-title">${card.title}</div>
                        <div class="card-description">${card.description}</div>
                        <div class="card-effect">${card.effect}</div>
                    </div>
                    <button class="game-button enter-game" onclick="this.parentElement.parentElement.remove(); applyCardEffect(${card.hearts});">繼續遊戲</button>
                </div>`;
            document.body.appendChild(modal);
        }

        function applyCardEffect(heartChange) {
            gameState.hearts += heartChange;
            if (gameState.hearts > 6) gameState.hearts = 6;
            updateStatusPanel();
            if (gameState.hearts <= 0) { setTimeout(() => showDefeatPage(), 1500); return; }
            gameState.questionsBeforeFateChance = 0;
            loadNextQuestion();
        }
        
        function populateResultStats(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const accuracy = gameState.totalQuestions > 0 ? ((gameState.correctAnswers / gameState.totalQuestions) * 100).toFixed(1) : '0.0';
            const minutes = Math.floor(gameState.elapsedTime / 60).toString().padStart(2, '0');
            const seconds = (gameState.elapsedTime % 60).toString().padStart(2, '0');
            const formattedTime = `${minutes}:${seconds}`;
            container.innerHTML = `
                <div class="result-stat-item"><div class="result-stat-label">角色名稱</div><div class="result-stat-value">${gameState.playerName}</div></div>
                <div class="result-stat-item"><div class="result-stat-label">總答題數</div><div class="result-stat-value">${gameState.totalQuestions}</div></div>
                <div class="result-stat-item"><div class="result-stat-label">答對</div><div class="result-stat-value highlight-green">${gameState.correctAnswers}</div></div>
                <div class="result-stat-item"><div class="result-stat-label">答錯</div><div class="result-stat-value highlight-red">${gameState.wrongAnswers}</div></div>
                <div class="result-stat-item"><div class="result-stat-label">答對率</div><div class="result-stat-value">${accuracy}%</div></div>
                <div class="result-stat-item"><div class="result-stat-label">遊戲時間</div><div class="result-stat-value">${formattedTime}</div></div>`;
        }

        function showVictoryPage() {
            clearInterval(gameState.gameTimer);
            document.getElementById('game-page').classList.add('hidden');
            populateResultStats('victory-stats-container');
            document.getElementById('victory-page').classList.remove('hidden');
        }

        function showDefeatPage() {
            clearInterval(gameState.gameTimer);
            document.getElementById('game-page').classList.add('hidden');
            populateResultStats('defeat-stats-container');
            document.getElementById('defeat-page').classList.remove('hidden');
        }

        async function downloadResultImage(elementId, event) {
            const button = event.target;
            const originalElement = document.getElementById(elementId);
            if (!originalElement || button.disabled) return;

            const originalButtonText = button.textContent;
            button.disabled = true;
            button.textContent = '正在產生圖片...';

            const captureContainer = document.createElement('div');
            captureContainer.style.position = 'absolute';
            captureContainer.style.left = '-9999px'; 
            captureContainer.style.top = '0px';
            captureContainer.style.width = originalElement.offsetWidth + 'px';
            
            const clone = originalElement.cloneNode(true);
            clone.style.background = '#ffffff'; 
            clone.style.backdropFilter = 'none';
            clone.style.boxShadow = '0 10px 30px rgba(0,0,0,0.1)'; 

            captureContainer.appendChild(clone);
            document.body.appendChild(captureContainer);
            
            try {
                const canvas = await html2canvas(clone, {
                    useCORS: true,
                    scale: 2, 
                    backgroundColor: '#ffffff'
                });
                
                const link = document.createElement('a');
                link.download = '勞基法試煉-挑戰紀錄.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

            } catch (error) {
                console.error('下載紀錄時發生錯誤:', error);
                alert('抱歉，下載紀錄時發生預期外的錯誤，請稍後再試。');
            } finally {
                document.body.removeChild(captureContainer);
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        }
        
        function restartGame() {
            document.querySelectorAll('.main-container').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.fate-chance-overlay').forEach(o => o.remove());
            document.getElementById('main-page').classList.remove('hidden');
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            gameState = {
                currentPage: 'main', selectedRole: '', selectedEmoji: '', playerName: '', hearts: 3, totalQuestions: 0,
                correctAnswers: 0, wrongAnswers: 0, currentQuestionIndex: 0, usedQuestions: [], selectedAnswer: null,
                questionsBeforeFateChance: 0, gameTimer: null, elapsedTime: 0
            };
            document.getElementById('game-timer').textContent = '00:00';
            document.querySelector('.name-input').value = '';
            document.querySelector('.name-input-section').style.display = 'none';
            document.querySelector('.start-button-section').style.display = 'none';
            document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
        }

        document.addEventListener('DOMContentLoaded', () => console.log('勞基法試煉遊戲已載入完成！'));
    </script>
</body>
</html>